---
output:
  pdf_document:
    df_print: kable
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, error = FALSE)
knitr::opts_chunk$set(dpi = 120)
```

# Microarray Data - GSE145483

## General info

This data set was generated by Catal√†-Moll et al. (2022) and aimed to identify differential methylation patterns in monocyte-derived dendritic cells after Vit D3 treatment. The original data set contains 12 samples: 4 replicates of human monocytes (MO) and monocyte-derived dendritic cells in the absence (DC) or presence (tolDC) of the active form of vitamin D.

**Microarray type:** Illumina Infinium HumanMethylation850 BeadChip

## Preparation

### Loading Libraries

```{r}
library('lumi')
library('wateRmelon')
library('ChAMPdata')
library('minfi')
library('IlluminaHumanMethylationEPICanno.ilm10b4.hg19')
library('IlluminaHumanMethylationEPICmanifest')
```

### Load the Data

Sample data is loaded.

```{r}
# anotation data
data_annot = read.table(
  "./data/annotation/GSE145483/Annotation_Infinium.txt", 
  header = TRUE, sep = "\t")
# infinium data
data_inf = readEPIC("./data/array145483/")
```

## Data exploration

The data has 12 samples (4 undifferentiated, 4 treated, and 4 control samples).

```{r}
knitr::kable(data_annot[,1:2])
```

Beta and M values are explored, only a minor amount of NA values were observed.

```{r}
print("Beta values:") # retrieve the beta-values (methylation percentage)
head(betas(data_inf), 2)
print("M-values: :") # retrieve the M-values
head(exprs(data_inf), 2)

print(paste("NA beta values:", sum(is.na(betas(data_inf)))))
print(paste("non-NA beta values:", sum(!is.na(betas(data_inf)))))
print(paste("NA M values:", sum(is.na(exprs(data_inf)))))
print(paste("non-NA M values:", sum(!is.na(exprs(data_inf)))))
```

## Prcoessing the data

### Data Filtering

This entries of the missing observation values are filtered out.

```{r}
# removing NA values
data_inf = data_inf[rowSums(is.na(exprs(data_inf))) == 0,]

print("After filtering:")
print(paste("NA beta values:", sum(is.na(betas(data_inf)))))
print(paste("non-NA beta values:", sum(!is.na(betas(data_inf)))))
print(paste("NA M values:", sum(is.na(exprs(data_inf)))))
print(paste("non-NA M values:", sum(!is.na(exprs(data_inf)))))
```

For a more simple comparison between treated and untreated samples, undifferentiated monocytes (MO) are not taken up into the model.

```{r}
# take subset
infdata = data_inf[
  ,c(grep("DC", data_annot[,2]), grep("TL", data_annot[,2]))]
annot = data_annot[
  c(grep("DC", data_annot[,2]), grep("TL", data_annot[,2])),]

knitr::kable(annot[,1:2])
```

Detection p-values and bead counts are filtered with the `pfilter` function of the wateRmelon package.

```{r}
infdata.pf = pfilter(infdata)
```

### General Statistics

Since beta- and M-values are to some extent extent intrinsically normalized, average methylation degree can be compared between samples as such.

Comparison of average degree of methylation between control and tumor samples on low dimensional data:

The boxplot of the beta values gives a general idea of the distribution of methylation degree per sample. A slight difference between samples can be observed, but there is no clear destinction between treated and untreated samples.

```{r}
cols <- c("blue", "blue", "blue", "blue", "red", "red", "red","red")
labs <- c("DC25", "DC26", "DC27", "DC28", "TL29", "TL30", "TL31", "TL32")
  
boxplot(
  betas(infdata.pf), xlab = "Sample", ylab = "Betas",
  col = cols, names = labs)
```

Comparison of average degree of methylation between control and tumor samples on high dimensional data:

```{r}
meth_mean_DC <- rep(0,4)
meth_mean_TL <- rep(0,4)
for (i in 1:ncol(infdata.pf)) {
  if (i < 5) {
    meth_mean_DC[i] <- mean(betas(infdata.pf)[,i])
  } else {
    meth_mean_TL[i-4] <- mean(betas(infdata.pf)[,i])
  }
}
```

The mean effect between control and treated samples is compared using a Welch t-test. Only a relatively low difference in methylation degree can be observed, and this is confirmed by the Welch test. There is also an increased variability in methylation degree for the treated samples.

```{r}
t_test_res <- t.test(meth_mean_DC, meth_mean_TL, var.equal = FALSE)
t_test_res
dat_boxplot <- data.frame(betas = c(meth_mean_DC, meth_mean_TL),
group = c("DC","DC","DC","DC","TL","TL","TL","TL"))

boxplot(betas ~ group, dat_boxplot, 
        xlab = "Group", ylab = "Mean Betas", col = c("blue", "red"))
```

## Processing

### Normalization and QC

Normalization function from the lumi package are used to adjust for color bias.

The density distribution and color bias distributions are plotted to assess the effect of normalization. A clear improvement is observed.

```{r}
# normalization
infdata.dasen.pf <- dasen(infdata.pf)
# methylumi objects to check density and color bias adjustment
infdataM <- as(infdata.pf, 'MethyLumiM')
infdataN <- as(infdata.dasen.pf, 'MethyLumiM')

# make plots
plotColorBias1D(infdataM, channel = "both", main = "before")
plotColorBias1D(infdataN, channel = "both", main = "after")
density(infdataM, main = "before", legend = FALSE)
density(infdataN, main = "after", legend = FALSE)
```

## Differential Methylation Analysis: LIMMA

LIMMA is used on the pre-processed M-values to identify methylation differences between treated and untreated samples.

### Design Matrix

A design matrix is constructed to account for the treatment effect.

```{r}
design <- model.matrix(~ factor(c(0, 0, 0, 0, 1, 1, 1, 1)))
colnames(design) <- c("Intercept", "Treatment")
knitr::kable(head(design))
```

### Contrast Matrix

A contrast matrix is generated to make pair-wise comparisons.

```{r}
cont.matrix <- makeContrasts(Treatment, levels = design)
```

### Model Fit

The processed data is fitted with a linear model.

```{r}
fit <- lmFit(infdataN, design)
fit2 <- contrasts.fit(fit, cont.matrix)
fit2 <- eBayes(fit2)
```

### Results Summarization

A table of the top most differentially methylated regions is generated. 1379 significant regions were obtained, slightly more than half of which corresponded to an increase in methylation after treatment.

```{r}
topMethyl <- topTable(fit2, adjust = "BH", number = nrow(exprs(infdataM)))
sigTopMethyl <- topMethyl[topMethyl$adj.P.Val < 0.05,]

print(paste(
  "Number of signifiant regions:", dim(sigTopMethyl)[1]))
print(paste(
  "Postive FC:", sum(sigTopMethyl$logFC > 0), 
  "Negative FC:", sum(sigTopMethyl$logFC < 0)))
knitr::kable(head(sigTopMethyl[c("logFC", "AveExpr", "P.Value", "adj.P.Val")]))
```

```{r}
plot(topMethyl$AveExpr, topMethyl$logFC, 
     col = as.factor(topMethyl$adj.P.Val < 0.05), 
     pch = 20, xlab = "Average M-value", ylab = "logFC", cex = 0.70)
```


### Functional Annotation of Results

The array probe annotation set is loaded and sorted based on probe name.

```{r}
data("probe.features.epic")
annotation_MA <- probe.features
annotation_MA <- annotation_MA[
  sort(rownames(annotation_MA), index.return = TRUE)$ix,]
```

A comparison is made between both probe sets. All probes that were detected during the experiment are present in the annotation probe set, the difference could be due to technical errors or the filtration procedure. Unnecessary probes were removed and annotation information was added to the probe table.

```{r}
print(paste(
    "Experimental probe set dimensions:", 
    dim(topMethyl)[1], 'x', dim(topMethyl)[2]))
print(paste(
  "Significant experimental probe set dimensions:", 
  dim(sigTopMethyl)[1], 'x', dim(sigTopMethyl)[2]))
print(paste(
  "Annotation probe set dimensions:", 
  dim(annotation_MA)[1], 'x', dim(annotation_MA)[2]))

print(paste(
  "Experimental probes present in annotation probe set:", 
  sum(topMethyl$Probe_ID %in% rownames(annotation_MA))))
print(paste(
  "Annotation probes present in experimental probe set:", 
  sum(rownames(annotation_MA) %in% topMethyl$Probe_ID)))

# remove unnecessary probes
annotation_MA_min <- annotation_MA[rownames(annotation_MA) %in% 
                                 sigTopMethyl$Probe_ID,]

# sort LIMMA output on probe name
sigTopMethyl_sorted <- sigTopMethyl[sort(
  sigTopMethyl$Probe_ID, index.return = TRUE)$ix,]
# Add gene names to LIMMA output
sigTopMethyl_sorted$Gene <- as.character(annotation_MA_min$gene)
sigTopMethyl_sorted$Feature <- as.character(annotation_MA_min$feature)
sigTopMethyl_sorted$Chrom <- as.character(annotation_MA_min$CHR)
sigTopMethyl_sorted$Pos <- annotation_MA_min$MAPINFO

knitr::kable(head(
  sigTopMethyl_sorted[c("logFC", "AveExpr", "P.Value", "adj.P.Val", "Gene")]))
```

## Gene Set Analysis

The genes are grouped into gene sets to identify pathways regulated by Vit D.

Firstly, rows for which no gene name is specified are filtered out.

```{r}
print(paste(
  "Number of probes without gene name:", 
  sum(sigTopMethyl_sorted$Gene == ''), '/', dim(sigTopMethyl_sorted)[1]))
sigTopMethyl_sorted <- sigTopMethyl_sorted[sigTopMethyl_sorted$Gene != '',]
knitr::kable(head(
  sigTopMethyl_sorted[c("logFC", "AveExpr", "P.Value", "adj.P.Val", "Gene")]))
```

The Entrez gene ID is fetched for both the significant and non-significant probes.

```{r}
library(biomaRt)

hsmart <- useMart(
  dataset = "hsapiens_gene_ensembl", biomart = "ensembl")

sigMappings <- getBM(
  attributes = 'entrezgene_id', 
  filters = 'hgnc_symbol',
  values = sigTopMethyl_sorted$Gene,
  mart = hsmart)

allMappings <- getBM(
  attributes = 'entrezgene_id', 
  filters = 'hgnc_symbol',
  values = annotation_MA$gene[annotation_MA$gene != ''],
  mart = hsmart)

knitr::kable(head(sigMappings))
```

A gene set table is generated.

```{r}
library(edgeR)

res <- kegga(de = sigMappings[,1],
             universe = allMappings[,1],
                 species.KEGG = "hsa")
res <- res[order(res$N),]
    
res$FDR.DE <- p.adjust(res$P.DE, n = nrow(res), method = "BH")

print(paste("Number of significant gene sets:", 
            sum(res$FDR.DE < 0.05), '/', dim(res)[1]))
knitr::kable(head(res[order(res$DE, decreasing = TRUE),]))
```

## Save Results

The resulting genes and gene sets are saved for further comparison with the other omics methods.

```{r}
# saving significant genes
write.csv(sigTopMethyl_sorted, 
          file = "./results/GSE145483/array145483_genes.csv")

# saving significant gene sets
write.csv(res, 
          file = "./results/GSE145483/array145483_genesets.csv")
```