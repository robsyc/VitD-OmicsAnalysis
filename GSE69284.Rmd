# RNAseq Data - GSE69284

## General info
This dataset (GSE69284) was generated in 2016 and aimed to identify genes regulated by Vit D in the human monocytic THP-1 cell line. Expression profiling was performed through high throughput RNA sequencing after treatment with Vit D3 for 2.5 / 4 / 24 h. This study was performed on 18 samples (in triplicate form), 4 of which were used for our data analysis.

- Read length: 51bp
- Single/paired end sequencing: single end sequencing
- Platform used: Illumina NextSeq500

## Quality control
A MultiQC quality control was performed and mapping statistics are provided through the kallisto log output.

TODO

```{r}

```


```{r, echo = FALSE, results='asis'}
htmltools::includeHTML("./stats/RNAseq/GSE69284/2_multiqc/multiqc_report.html")
```

## Generating Counts With Kallisto

TODO

## Downstream Analysis

### Loading Libraries

```{r echo=FALSE, results='hide', error=FALSE, warning=FALSE, message=FALSE}
# install packages if not yet installed.
pkgs <- c("txmport", "dplyr", "edgeR", "biomaRt")
notInstalled <- pkgs[!pkgs %in% installed.packages()[,1]]
if(length(notInstalled) > 0){
  BiocManager::install(notInstalled)
}

library(tximport)
library(dplyr)
library(edgeR)
library(biomaRt)
```

### Pseudo count table

Kallisto transcript mapping was performed to generate a pseudo-count table.

The transcript annotation data is extracted.

```{r}
# annotation data
GRCh38 <-  useEnsembl(biomart="genes", host="https://www.ensembl.org", dataset="hsapiens_gene_ensembl")

# attributes
atr <- listAttributes(GRCh38)
atr
data <- getBM(attributes = c('ensembl_gene_id', 'ensembl_transcript_id', 'external_gene_name'), mart = GRCh38)

tx2geneGtf <- dplyr::select(data, ensembl_transcript_id, ensembl_gene_id)

# maps transcript -> gene
tx2geneGtf <- rename(tx2geneGtf, TXNAME = ensembl_transcript_id)
tx2geneGtf <- rename(tx2geneGtf, GENEID = ensembl_gene_id)
head(tx2geneGtf)
```

The Kallisto pseudoalignment data is loaded.

Search for the Kallisto output files.

```{r}
files <- list.files("./stats/RNAseq/GSE69284", recursive=TRUE)

abundance_files <- grep("abundance_bis.tsv", files, value=TRUE)
samples <- gsub("(.*)_quant.*", "\\1", abundance_files, perl=TRUE)
abundance_files <- paste(rep("./stats/RNAseq/GSE69284/"), abundance_files, sep="")

names(abundance_files) <- samples
```

Load RNAseq data

```{r}
txi <- tximport(abundance_files, type = "kallisto", tx2gene = tx2geneGtf)

head(txi$counts)
dim(txi$counts)
```

### Preprocessing

#### Duplicates

Check for duplicate gene counts?

```{r}
dups = duplicated(rownames(txi$counts))
sum(dups)
```


#### Annotation

General sample annotation file was provided.  
A case-control study was performed with 3 different treatment groups (2.5, 4, and 24 hour exposure) in the THP-1 cell line. The treatment time will be added as a factor during statistical analysis.

```{r}
RNAseq_annot <- read.csv("./data/annotation/GSE69284/SraRunTable.txt")
colnames(RNAseq_annot)

annotation <- RNAseq_annot[c("TREATMENT", "Treatment_Time")]
colnames(annotation) <- c("treatment", "time")
rownames(annotation) <- RNAseq_annot$Run

# convert into factors
annotation$treatment <- factor(annotation$treatment, levels=c("Ethanol", "100 nM 1\\,25(OH)2D3"), labels=c("Ethanol", "VitD"))
annotation$time <- factor(annotation$time, levels=c("2.5 h", "4 h", "24 h"), labels=c("2.5h", "4h", "24h"))

annotation
```

Check if the colnames match up in order with the annotation data.

```{r}
rownames(annotation) == colnames(txi$counts)
```

## EdgeR Analysis
### Normalisation
As we're working with *pseudocounts* (summerized gene counts from transcript counts), we need to add extra bias correction offsets (based on average transcript length) to make the data fit for EdgeR gene-level analysis.

```{r}
## Make tpm values compatible with edgeR
cts <- txi$counts
normMat <- txi$length
# Obtaining per-observation scaling factors for length, adjusted to avoid
# changing the magnitude of the counts.
normMat <- normMat/exp(rowMeans(log(normMat)))
normCts <- cts/normMat
# Computing effective library sizes from scaled counts, to account for
# composition biases between samples.
eff.lib <- calcNormFactors(normCts) * colSums(normCts)
# Combining effective library sizes with the length factors, and calculating
# offsets for a log-link GLM.
normMat <- sweep(normMat, 2, eff.lib, "*")
normMat <- log(normMat)
```

### Create DGEList object

```{r}
dge <- DGEList(cts)
dge <- scaleOffset(dge, normMat)
```

### Design Matrix

```{r}
design <- model.matrix(~time * treatment, annotation)
rownames(design) <- colnames(dge)
design
```

### Filtering

```{r}
keep <- filterByExpr(dge,design)
print(table(keep))
dge <- dge[keep, , keep.lib.sizes=FALSE]
```

### Data exploration

MDS plot

```{r}
limma::plotMDS(dge,labels=paste(annotation$treatment,annotation$time,sep=" - "),col=as.double(annotation$treatment))
```

Observations:
- maybe no time effect for Ethanol treated samples? (expected)
- time effect for VitD treated samples (expected)


### Estimate dispersion

```{r}
dge <- estimateDisp(dge, design)  
plotBCV(dge)
```

Looks OK? -> TODO: why

### Fit quasi-negative binomial model


```{r}
fit <- glmQLFit(dge,design)
```

### Define contrasts

TODO: do the contrasts properly

```{r}
L <- msqrob2::makeContrast(
    c("treatmentVitD = 0",
      "time24h:treatmentVitD = 0",
      "time4h:treatmentVitD = 0",
      "treatmentVitD + time4h:treatmentVitD = 0",
      "treatmentVitD + time24h:treatmentVitD + time4h:treatmentVitD = 0",
      "time4h = 0",
      "time24h = 0"),
    parameterNames = colnames(design))
L
```

Perform Contrast Tests

```{r}
testsF <- apply(L, 2, function(fit,contrast) 
    glmQLFTest(fit,contrast=contrast), 
    fit = fit)

topTablesF<- lapply(testsF, topTags, n=nrow(dge))

sig_counts <- sapply(topTablesF, function(x) sum(x$table$FDR< 0.05))
sig_counts
```

Expected, there shouldn't really be a time effect? (as Ethanol does nothing?)

### Volcano Plots

```{r}
library(ggplot2)
for (i in 1:ncol(L))
{
   volcano<- ggplot(topTablesF[[i]]$table,aes(x=logFC,y=-log10(PValue),color=FDR < 0.05)) + geom_point() + scale_color_manual(values=c("black","red")) + ggtitle(paste("contrast",names(topTablesF)[i]))
print(volcano)
}
```

### Histograms of P-values

```{r}
histsP <- lapply(topTablesF, function(x) 
    x$table %>% 
        ggplot(aes(x=PValue)) + 
        geom_histogram(breaks =seq(0,1,.1) ,col=1)
    )
    
for (i in 1:ncol(L)) 
    histsP[[i]] <- histsP[[i]] +
    ggtitle(paste("contrast",names(topTablesF)[i]))
histsP
```

TODO: some of these plots might seem a bit weird.

### Checks

Convert gene symbol into ensembl id.

```{r}
symbol2ensembl = function(x) {
  return(data[data$external_gene_name == x, "ensembl_gene_id"][1])
}
```

```{r}
genes2.5h <- topTablesF$treatmentVitD$table
genes4h <- topTablesF$`treatmentVitD + time4h:treatmentVitD`$table
genes24h <- topTablesF$`treatmentVitD + time24h:treatmentVitD + time4h:treatmentVitD`$table
```

TODO: actual interpretation

#### Percentages upregulated vs downregulated genes

In the paper:
- 2.5h: 100% up
- 4h: 59% up
- 24h: 55.1% up

TODO: why the mismatch?

```{r}
sig2.5 = genes2.5h %>% filter(FDR < 0.05)
c2.5up = sig2.5 %>% filter(logFC > 0) %>% count
c2.5 = sig2.5 %>% count

print(c2.5up / c2.5)

sig4 = genes4h %>% filter(FDR < 0.05)

c4up = sig4 %>% filter(logFC > 0) %>% count - c2.5up
c4 = sig4 %>% count - c2.5

print(c4)
print(c4up / c4)


sig24 = genes24h %>% filter(FDR < 0.05)
c24up = sig24 %>% filter(logFC > 0) %>% count - c4up - c2.5up
c24 = sig24 %>% count - c4 - c2.5

print(c24)
print(c24up / c24)

```

#### Number of genes that only become significant after 24h
In the paper they mention that only after 24h of treatment, 995 genes become significantly expressed.

We count:

```{r}
at_24h = sig_counts["treatmentVitD + time24h:treatmentVitD + time4h:treatmentVitD"]
at_4h = sig_counts["treatmentVitD + time4h:treatmentVitD"]

at_24h - at_4h
```

#### NOD2

According to this paper (*Epigenome-wide effects of vitamin D and their impact on the transcriptome of human monocytes involve CTCF*),
expression of this gene ENSG00000167207 (NOD2), is only affected after 24h .

Evaluate this.

```{r}
gene <- symbol2ensembl("NOD2")

genes2.5h[gene,]$FDR
genes4h[gene,]$FDR
genes24h[gene, ]$FDR
```
Indeed, only somewhat significant after 24h of treatment.

#### HTT
HTT: ENSG00000197386

Should become significant after 4h of treatment.

```{r}
gene = symbol2ensembl("HTT")

genes2.5h[gene,]$FDR
genes4h[gene,]$FDR
genes24h[gene, ]$FDR
```

Indeed, only somewhat significant after 4h of treatment.

 
#### THBD

Significant gene from the GSE5145 microarray dataset.

- THBD: ENSG00000178726
- PEAK1: 

```{r}


gene <- symbol2ensembl("THBD")
gene

genes2.5h[gene,]$FDR
genes4h[gene,]$FDR
genes24h[gene, ]$FDR


gene <- symbol2ensembl("PEAK1")
gene

genes2.5h[gene,]$FDR
genes4h[gene,]$FDR
genes24h[gene, ]$FDR


gene <- symbol2ensembl("SULT1C2")
gene

genes2.5h[gene,]$FDR
genes4h[gene,]$FDR
genes24h[gene, ]$FDR

```

### Gene Set Analysis
We will use Kegga to gather gene ontology terms.

Need to incorporate transcript length in the analysis as it is easier for longer transcripts to be expressed as it will have more reads, and thus higher counts (which also means lower variance and thus easier to detect as differentially expressed).

```{r}
library(limma)

# to map the ensembl gene ids to entrez ids (input for kegga)
gid <- getBM(attributes = c("ensembl_gene_id", "external_gene_name", "entrezgene_id", "transcript_length"), mart=GRCh38)
gid <- gid[!duplicated(gid$ensembl_gene_id),]
```

Universe (expressed genes after filtering)

```{r}

univ <- genes4h

gid_f = gid[gid$ensembl_gene_id %in% rownames(univ), ]
genes_sort <- genes[order(rownames(univ)),]
gid_f_sort <- gid_f[order(gid_f$ensembl_gene_id),]

univ$gene_symbol <- gid_f_sort$external_gene_name
univ$entrez_gene_id <- gid_f_sort$entrezgene_id

univ <- univ[!is.na(univ$entrez_gene_id),]
```

```{r}
sig2.5 <- genes2.5h[genes2.5h$FDR < 0.2,]
print(dim(sig2.5))

sig4 <- genes4h[genes4h$FDR < 0.2,]
sig4 <- sig4[!(rownames(sig4) %in% rownames(sig2.5)), ]
print(dim(sig4))


sig24 <- genes24h[genes24h$FDR < 0.2,]
sig24 <- sig24[!(rownames(sig24) %in% rownames(sig4) | rownames(sig24) %in% rownames(sig2.5)), ]
print(dim(sig24))

```

```{r}
for (idx in 1:3) {

    if (idx == 1) {
        genes <- sig2.5
    } else if (idx == 2) {
        genes <- sig4
    } else {
        genes <- sig24
    }      

    # relax as otherwise too less significant genes
    # filter out the DE genes
    print(dim(genes))

    gid_f = gid[gid$ensembl_gene_id %in% rownames(genes), ]
    genes_sort <- genes[order(rownames(genes)),]
    gid_f_sort <- gid_f[order(gid_f$ensembl_gene_id),]

    genes_sort$gene_symbol <- gid_f_sort$external_gene_name
    genes_sort$entrez_gene_id <- gid_f_sort$entrezgene_id
    genes_sort$transcript_length <- gid_f_sort$transcript_length

    # Analysis with Kegga:

    # not all genes have an entrez idz
    genes_sort <- genes_sort[!is.na(genes_sort$entrez_gene_id),]

    # filter out NA values

    res <- kegga(de=genes_sort$entrez_gene_id,
                 universe = univ$entrez_gene_id,
                 species.KEGG="hsa", trend=genes_sort$transcript_length)
    res <- res[order(res$N),]
    
    res$FDR.DE <- p.adjust(res$P.DE, n=nrow(res), method="BH")
    print(head(res[order(res$DE, decreasing=TRUE),]))
    
    #res_f <- res[res$FDR.DE < 0.20,]
    print(head(res_f[order(res_f$FDR.DE),]))
}
```
